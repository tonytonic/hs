<!DOCTYPE html>
<html lang="fr">
<head>
<link rel="manifest" href="/manifest.json">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="Compteur Heures & Paie">
<meta name="theme-color" content="#4FB3C2">
<meta charset="UTF-8">
<title>Compteur Heures Sup â€“ AUTO (Report + dÃ©tail majorations)</title>
<button class="menu-btn" onclick="goMenu()">â¬… Retour au menu</button>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
.menu-btn {
  margin-top: 8px;
  margin-bottom: 20px;
  padding: 8px 16px;
  border-radius: 20px;
  border: none;
  background: rgba(255,255,255,0.85);
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
}
/* ğŸ› ï¸ FIX SAFARI iOS â€” EmpÃªcher le rÃ©trÃ©cissement des select */
.month-nav {
  display: flex; /* Utiliser flex pour plus de stabilitÃ© */
  gap: 10px;
  margin-bottom: 10px;
  width: 100%;
}

.month-nav select {
  flex: 1;           /* Partage l'espace Ã©quitablement */
  min-height: 40px;  /* Taille tactile confortable */
  display: block;
  width: 100%;
  box-sizing: border-box;
  background-color: #fff;
  /* Force l'apparence standard pour Ã©viter le bug de rendu iOS */
  -webkit-appearance: menulist; 
  border: 1px solid #ccc;
  border-radius: 4px;
}


/* PARTIE 1 â€” configuration repliable */
.section summary{
  cursor:pointer;
  font-weight:bold;
  background:#eeeeee;
  padding:10px;
  border-radius:8px;
  margin-bottom:10px;
}

.section[open] summary{
  background:#e0e0e0;
}

/* PARTIE 3 â€” dÃ©tails repliables */
.calc-details summary{
  cursor:pointer;
  font-weight:bold;
  background:#e3f2fd;
  padding:8px;
  border-radius:6px;
  margin-bottom:8px;
}

.calc-details[open] summary{
  background:#bbdefb;
}
body{font-family:Arial,sans-serif;background:#f2f2f2;padding:15px}
h1,h2{text-align:center}
.config,.totaux{background:#fff;padding:15px;border-radius:8px;max-width:900px;margin:15px auto}
.calendar-wrapper{max-width:900px;margin:20px auto}
.weekdays,.calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:5px}
.weekday{text-align:center;font-weight:bold;background:#ddd;padding:8px 0;border-radius:6px}
.day{
  background:#fff;
  padding:6px;
  border-radius:6px;
  cursor:pointer;
  text-align:center;
  height:80px;              /* ğŸ”’ taille fixe */
  box-sizing:border-box;
  overflow:hidden;          /* empÃªche lâ€™agrandissement */
  display:flex;
  flex-direction:column;
  justify-content:space-between;
}
  .day small{
  font-size:11px;
  line-height:1.1;
  white-space:nowrap;
}
.day.in-period{border:2px solid #2e7d32;background:#e8f5e9}
button,
input,
textarea{
  width:100%;
  padding:8px;
  margin:5px 0;
}
.popup{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.5);
  display:none;

  /* âœ… Bottom sheet mobile */
  align-items:flex-end;
  justify-content:center;

  z-index:10;
}
.popup-content{
  background:#fff;
  width:100%;
  max-width:500px;

  max-height:calc(100vh - 60px);
  overflow-y:auto;

  border-radius:16px 16px 0 0;

  padding:16px;
  padding-bottom:calc(16px + env(safe-area-inset-bottom));
}
.breakdown{background:#f9f9f9;padding:10px;border-radius:6px;margin-top:10px;font-size:14px}
.day.today{outline:3px solid #ff9800;box-shadow:0 0 6px rgba(255,152,0,.8)}
/* ğŸ‘‡ Indicateur visuel bottom sheet */
.sheet-handle{
  width:40px;
  height:4px;
  background:#ccc;
  border-radius:2px;
  margin:6px auto 10px;
}

/* ğŸ‘‡ Blocs + / âˆ’ / absence */
.block{border:none;margin-bottom:16px}
.block.plus legend{color:#1976d2}
.block.minus legend{color:#ef6c00}
.block.absence legend{color:#c62828}

/* ğŸ‘‡ Boutons dâ€™actions toujours visibles */
.popup-actions{
  position:sticky;
  bottom:env(safe-area-inset-bottom);
  background:#fff;
  padding-top:10px;
}

</style>
</head>

<body>
  <div id="exerciseAlert" style="
  display:none;
  max-width:900px;
  margin:10px auto;
  background:#fff3cd;
  border:1px solid #ffeeba;
  color:#856404;
  padding:12px;
  border-radius:8px;
  font-weight:bold;
  text-align:center;
">
  âš ï¸ Action requise : DÃ©finissez votre date de dÃ©but d'exercice dans la Configuration pour activer le calendrier.
</div>


<div class="popup" id="popupNotice">
  <div class="popup-content" style="max-width:800px;max-height:80vh;overflow:auto;">
    <h3>ğŸ“˜ Notice utilisateur â€“ Compteur annuel dâ€™heures</h3>

    <p>
      Cet outil permet de suivre et dâ€™estimer les heures de travail,
      les heures supplÃ©mentaires, les rÃ©cupÃ©rations et les absences
      dans le cadre dâ€™un <b>compteur annuel</b>.
    </p>

    <hr>

    <h4>ğŸ—“ï¸ Principe gÃ©nÃ©ral</h4>
    <p>
      Le suivi est organisÃ© par exercice annuel, dÃ©coupÃ© en pÃ©riodes
      comptables. Les calculs sont rÃ©alisÃ©s semaine par semaine,
      puis cumulÃ©s sur lâ€™annÃ©e.
    </p>

    <h4>â±ï¸ Base hebdomadaire</h4>
    <p>
      La base hebdomadaire (ex : 35h) reprÃ©sente une semaine complÃ¨te
      thÃ©orique avant prise en compte des absences, rÃ©cupÃ©rations
      et jours fÃ©riÃ©s.
    </p>

    <h4>âŒ Absences</h4>
    <p>
      Les absences correspondent Ã  du temps non travaillÃ©.
      Elles rÃ©duisent le volume dâ€™heures attendues dans la semaine
      et ne gÃ©nÃ¨rent pas dâ€™heures supplÃ©mentaires.
    </p>

    <h4>ğŸ” RÃ©cupÃ©rations</h4>
    <p>
      Les rÃ©cupÃ©rations sont des heures prÃ©cÃ©demment travaillÃ©es,
      reprises ultÃ©rieurement sous forme de repos.
    </p>

    <p>
      <b>Dans cet outil, les rÃ©cupÃ©rations sont assimilÃ©es Ã  du temps
      non travaillÃ© et rÃ©duisent le volume hebdomadaire de rÃ©fÃ©rence
      dans le cadre dâ€™un compteur annuel.</b>
    </p>

    <h4>â• Heures supplÃ©mentaires</h4>
    <p>
      Les heures supplÃ©mentaires sont dÃ©clenchÃ©es uniquement
      aprÃ¨s dÃ©passement de lâ€™Ã©quivalent de 35 heures
      rÃ©ellement travaillÃ©es sur la semaine.
    </p>

    <ul>
      <li>36áµ‰ Ã  43áµ‰ heure : majoration 25 %</li>
      <li>Au-delÃ  : majoration 50 %</li>
    </ul>

    <h4>ğŸ“† PÃ©riodes et clÃ´tures</h4>
    <p>
      Les pÃ©riodes se terminent le dimanche.
      La pÃ©riode suivante dÃ©bute automatiquement le lundi.
    </p>

 <h4>ğŸ”’ Verrouillage de la configuration</h4>
<p>
  Il est possible de verrouiller les paramÃ¨tres gÃ©nÃ©raux
  (date de dÃ©but, base hebdomadaire, clÃ´ture annuelle)
  afin dâ€™Ã©viter toute modification involontaire.
</p>
    <h4>ğŸ’¾ Sauvegarde</h4>
    <p>
      Les donnÃ©es sont enregistrÃ©es localement sur lâ€™appareil utilisÃ©.
      Il est fortement recommandÃ© dâ€™effectuer des exports rÃ©guliers
      pour sÃ©curiser le suivi annuel.
    </p>

    <hr>

    <p style="font-size:12px;color:#777">
      Cette notice est fournie Ã  titre informatif.
      Lâ€™outil ne constitue pas un logiciel de paie
      et ne se substitue pas aux documents officiels de lâ€™employeur.
    </p>
<hr>
<button onclick="closeNotice()">Fermer</button>
  </div>
</div>
<h1>Compteur Heures Sup</h1>
<p style="text-align:center">

</p>
<p style="text-align:center">
  Exercice : <b id="activeYearLabel"></b>
  <button onclick="switchYear()">ğŸ“ Changer</button>
</p>


<details class="section">
 <summary>
  ğŸ”§ Configuration
</summary>

  <div class="config">

    <label><b>Date de dÃ©but dâ€™exercice</b></label>
    <input type="date" id="exerciseStartInput">
<hr>
<label><b>Base hebdomadaire (heures)</b></label>
<input
  type="number"
  step="0.5"
  id="baseHebdoInput"
>
  <h2>ClÃ´tures mensuelles</h2>
   <button onclick="openClosures()">ğŸ“… ClÃ´tures mensuelles</button>
    <select id="periodSelect"></select>
    <p id="periodInfo"></p>

    <div id="rateContainer"></div>
<hr>
<button onclick="toggleConfigLock()">ğŸ”’ / ğŸ”“ Verrouiller la configuration</button>
<p id="configLockInfo"></p>
  <hr>
<button onclick="importJSON()">â¬†ï¸ Importer (.json)</button>
<button onclick="exportMonthlyFullPDF()">ğŸ“„ PDF mensuel complet</button>
<button onclick="exportAnnualPDF()">ğŸ“• PDF annuel complet</button>
<button onclick="exportPeriodPDF()">ğŸ“˜ Export PDF de la pÃ©riode</button>
    <hr>
    <label>Date de clÃ´ture annuelle</label>
    <input type="date" id="annualDateInput">

    <hr>
    <h2>Jours fÃ©riÃ©s</h2>
    <button onclick="importFeries()">ğŸ‡«ğŸ‡· Importer les jours fÃ©riÃ©s officiels</button>
<hr>
<button
  onclick="resetCurrentExercise()"
  style="background:#ffcdd2;color:#b71c1c;font-weight:bold"
>
  â™»ï¸ RÃ©initialiser lâ€™exercice en cours
</button>
  </div>
</details>
<div id="activePeriodBanner" style="
  max-width:900px;
  margin:10px auto;
  background:#e3f2fd;
  border:1px solid #90caf9;
  padding:8px 12px;
  border-radius:8px;
  font-size:14px;
  font-weight:bold;
">
</div>
<div class="calendar-wrapper main-zone">
<div class="month-nav">
<select id="monthSelect"></select>
<select id="yearSelect"></select>
</div>

<div class="weekdays">
<div class="weekday">Lun</div><div class="weekday">Mar</div><div class="weekday">Mer</div>
<div class="weekday">Jeu</div><div class="weekday">Ven</div><div class="weekday">Sam</div><div class="weekday">Dim</div>
</div>
<div class="calendar" id="calendar"></div>
</div>
<div style="
  max-width:900px;
  margin:15px auto;
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  justify-content:space-between;
">

 <div style="display:flex; gap:10px; flex-wrap:wrap;">
  <button onclick="exportJSON()" style="
    background:#e8f5e9;
    border:1px solid #2e7d32;
    font-weight:bold;
  ">
    ğŸ’¾ Sauvegarde dans un fichier
  </button>
</div>
<div id="saveBadges" style="
  font-size:13px;
  color:#2e7d32;
  margin-top:6px;
  width:100%;
">
  <span id="autoSaveBadge">ğŸŸ¢ Dans lâ€™application : â€”</span><br>
  <span id="fileSaveBadge">ğŸ’¾ Sauvegarde fichier : â€”</span>
</div>
  <span style="
    font-size:13px;
    color:#2e7d32;
    align-self:center;
  ">
    Sauvegarde automatique dans lâ€™application Â· Sauvegarde fichier recommandÃ©e
  </span>

</div>
<div class="totaux main-zone" id="totaux"></div>

<div class="popup" id="popup">
<div class="popup-content">
  <div class="sheet-handle"></div>
<h3 id="popupDate"></h3>

<fieldset class="block plus">
  <legend>â• Heures supplÃ©mentaires</legend>
  <button onclick="addExtra(0.25)">+15 min</button>
  <button onclick="addExtra(0.5)">+30 min</button>
  <button onclick="addExtra(1)">+1 h</button>
  <button onclick="addExtra(2)">+2 h</button>
  <input id="manualExtra" type="number" step="0.25">
</fieldset>

<fieldset class="block minus">
  <legend>â– RÃ©cupÃ©ration</legend>
  <button onclick="addRecup(0.25)">-15 min</button>
  <button onclick="addRecup(0.5)">-30 min</button>
  <button onclick="addRecup(1)">-1 h</button>
  <input id="manualRecup" type="number" step="0.25">
</fieldset>

<fieldset class="block absence">
  <legend>âŒ Absence</legend>
  <label>
    <input type="checkbox" id="isAbsent"> Jour d'absence
  </label>
  <input id="absentHours" type="number" step="0.25">
</fieldset>

<div class="popup-actions">
  <button onclick="saveManual()">Valider</button>

  <button onclick="resetDay()" style="background:#c62828;color:#fff">
    ğŸ—‘ï¸ Supprimer les heures du jour
  </button>

  <button onclick="closePopup()">Annuler</button>
</div>
</div>
</div>

<div class="popup" id="popupJSON">
<div class="popup-content">
<h3 id="jsonTitle"></h3>
<textarea id="jsonArea" style="width:100%;height:200px"></textarea>
<button onclick="confirmImportJSON()">Importer</button>
<button onclick="closeJSONPopup()">Fermer</button>
</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
document.querySelectorAll('.popup').forEach(p=>{
  p.addEventListener('click', e=>{
    if(e.target === p && p.id === "popup"){
      closePopup();
    }
  });
});
let midnightTimer = null

function goMenu() {
    localStorage.removeItem("lastApp");
    window.location.href = "../menu.html";
    }
function autoSwitchPeriodAtMidnight(){
  const now = new Date()

  const nextMidnight = new Date(
    now.getFullYear(),
    now.getMonth(),
    now.getDate() + 1,
    0, 0, 0, 0
  )

  const delay = nextMidnight - now

  // ğŸ”’ SÃ©curisation : un seul timer actif
  if(midnightTimer){
    clearTimeout(midnightTimer)
  }

  midnightTimer = setTimeout(() => {
    buildPeriods()
    update()
    showToast()
    autoSwitchPeriodAtMidnight() // relance pour la nuit suivante
  }, delay)
}

// ===== MULTI-ANNÃ‰E =====
let currentSuffix = localStorage.getItem("ACTIVE_YEAR_SUFFIX") || new Date().getFullYear();
document.getElementById("activeYearLabel").textContent = currentSuffix;

function resetCurrentExercise(){
  if(!confirm("âš ï¸ RÃ©initialiser complÃ¨tement lâ€™exercice " + currentSuffix + " ?\n\nToutes les donnÃ©es seront supprimÃ©es.")) {
    return;
  }

  const suffix = currentSuffix;

  const keys = [
    "DATA_REPORT_",
    "CLOSURES_REPORT_",
    "REPORTS_REPORT_",
    "PERIOD_META_REPORT_",
    "ANNUAL_DATE_",
    "SPECIAL_DAYS_",
    "EXERCISE_START_"
  ];

  keys.forEach(prefix => {
    localStorage.removeItem(prefix + suffix);
  });

  alert("âœ… Exercice " + suffix + " remis Ã  zÃ©ro");
  location.reload();
}
function resetDay(){
  if(!selectedDate) return;

  if(!confirm("âŒ Supprimer toutes les donnÃ©es de cette journÃ©e ?")){
    return;
  }

  // Supprimer les donnÃ©es du jour
  delete data[selectedDate];

  save();        // sauvegarde + badges
  closePopup(); // ferme la bottom sheet
}
function checkExerciseStartAlert(){
  const alertBox = document.getElementById("exerciseAlert")
  if(!exerciseStart){
    alertBox.style.display = "block"
  } else {
    alertBox.style.display = "none"
  }
}
function switchYear(){
  openYearsPopup()
}
function openYearsPopup(){
  const box = document.getElementById("yearsList")
  box.innerHTML = ""

  const years = getExistingYears()

  if(years.length === 0){
    box.innerHTML = "<i>Aucun exercice existant</i>"
  } else {
    years.forEach(y=>{
      const btn = document.createElement("button")
      btn.textContent = y + (String(y) === String(currentSuffix) ? " (actif)" : "")
      btn.onclick = () => {
        localStorage.setItem("ACTIVE_YEAR_SUFFIX", y)
        location.reload()
      }
      box.appendChild(btn)
    })
  }

  document.getElementById("popupYears").style.display = "flex"
}
function saveManual(){
  if(!selectedDate) return

  if(!data[selectedDate]){
    data[selectedDate] = { extra:0, recup:0, absent:0 }
  }

  data[selectedDate].extra = Number(manualExtra.value) || 0
  data[selectedDate].recup = Number(manualRecup.value) || 0

  if(isAbsent.checked){
    data[selectedDate].absent =
      Number(absentHours.value) || DAILY_WORK_HOURS
  } else {
    data[selectedDate].absent = 0
  }

  save()
  closePopup()
}
function closeYearsPopup(){
  document.getElementById("popupYears").style.display = "none"
}

function confirmSwitchYear(){
  const val = document.getElementById("newYearInput").value
  if(!val) return

  // ğŸ”¹ Initialisation minimale si l'exercice n'existe pas
  const baseKey = "DATA_REPORT_" + val
  if(!localStorage.getItem(baseKey)){
    localStorage.setItem(baseKey, JSON.stringify({}))
    localStorage.setItem("CLOSURES_REPORT_" + val, JSON.stringify([]))
    localStorage.setItem("REPORTS_REPORT_" + val, JSON.stringify({}))
    localStorage.setItem("PERIOD_META_REPORT_" + val, JSON.stringify({}))
  }

  localStorage.setItem("ACTIVE_YEAR_SUFFIX", val)
  location.reload()
}
function addRecup(h){
  if(!data[selectedDate]) data[selectedDate]={extra:0,recup:0}

  const newVal =
    Math.round((data[selectedDate].recup + h) * 4) / 4

  data[selectedDate].recup = ALLOW_RECUP_FREE
    ? newVal
    : Math.min(newVal, data[selectedDate].extra)

  save()
  closePopup()
}
function addExtra(h){
  if(!data[selectedDate]) data[selectedDate]={extra:0,recup:0}
  data[selectedDate].extra =
    Math.round((data[selectedDate].extra + h) * 4) / 4
  save()
  closePopup()
}
function getExistingYears(){
  const years = new Set()

  for(let i=0; i<localStorage.length; i++){
    const key = localStorage.key(i)
    if(key.startsWith("DATA_REPORT_")){
      years.add(key.replace("DATA_REPORT_", ""))
    }
  }

  return Array.from(years).sort()
}
// ===== STOCKAGE DYNAMIQUE =====
const STORAGE = {
  data: "DATA_REPORT_" + currentSuffix,
  closures: "CLOSURES_REPORT_" + currentSuffix,
  reports: "REPORTS_REPORT_" + currentSuffix,
  annualDate: "ANNUAL_DATE_" + currentSuffix,
  specialDays: "SPECIAL_DAYS_" + currentSuffix,
  exerciseStart: "EXERCISE_START_" + currentSuffix
};

STORAGE.periodMeta = "PERIOD_META_REPORT_" + currentSuffix;

// ===== DONNÃ‰ES =====
let data = JSON.parse(localStorage.getItem(STORAGE.data)) || {};
let closures = JSON.parse(localStorage.getItem(STORAGE.closures)) || [];
let reports = JSON.parse(localStorage.getItem(STORAGE.reports)) || {};

let annualDate = localStorage.getItem(STORAGE.annualDate) || "";
let annualRate =
  Number(localStorage.getItem("ANNUAL_RATE_" + currentSuffix)) || 10;
let specialDays = JSON.parse(localStorage.getItem(STORAGE.specialDays)) || {};
let exerciseStart = localStorage.getItem(STORAGE.exerciseStart) || "";
let periodMeta = JSON.parse(localStorage.getItem(STORAGE.periodMeta)) || {}
let BASE_HEBDO =
  Number(localStorage.getItem("BASE_HEBDO_" + currentSuffix)) || 35;
const DAILY_WORK_HOURS = 7; // base journaliÃ¨re lÃ©gale
// OPTION : autoriser la rÃ©cup mÃªme sans heures sup le mÃªme jour
const ALLOW_RECUP_FREE = true;
const months=["Janvier","FÃ©vrier","Mars","Avril","Mai","Juin","Juillet","AoÃ»t","Septembre","Octobre","Novembre","DÃ©cembre"]
const monthSelect=document.getElementById("monthSelect")
const yearSelect=document.getElementById("yearSelect")
const periodSelect=document.getElementById("periodSelect")
const calendar=document.getElementById("calendar")
const periodInfo=document.getElementById("periodInfo")
const totaux=document.getElementById("totaux")
const popup = document.getElementById("popup")
const popupDate = document.getElementById("popupDate")
const manualExtra = document.getElementById("manualExtra")
const manualRecup = document.getElementById("manualRecup")
const isAbsent = document.getElementById("isAbsent")
const absentHours = document.getElementById("absentHours")

const popupJSON = document.getElementById("popupJSON")
const jsonTitle = document.getElementById("jsonTitle")
const jsonArea = document.getElementById("jsonArea")
  
let view=new Date()
let viewMonth=view.getMonth()
let viewYear=view.getFullYear()
let selectedDate=""
let currentPeriodIndex=0
// ğŸ”’ ClÃ© de date locale (Ã©vite les bugs UTC / changement dâ€™annÃ©e)
function dateKeyLocal(d){
  const y = d.getFullYear()
  const m = String(d.getMonth() + 1).padStart(2, "0")
  const day = String(d.getDate()).padStart(2, "0")
  return `${y}-${m}-${day}`
}
function getBaseStartDate(){
  if(!exerciseStart){
    return null;
  }
  return new Date(exerciseStart);
}


function initSelectors(){
monthSelect.innerHTML=""
months.forEach((m,i)=>{
const o=document.createElement("option")
o.value=i;o.textContent=m
if(i===viewMonth)o.selected=true
monthSelect.appendChild(o)
})
yearSelect.innerHTML=""
for(let y=viewYear-2;y<=2050;y++){
const o=document.createElement("option")
o.value=y;o.textContent=y
if(y===viewYear)o.selected=true
yearSelect.appendChild(o)
}
}

function openClosures(){
const box=document.getElementById("closuresInputs")
box.innerHTML=""
for(let i=0;i<12;i++){
const input=document.createElement("input")
input.type="date"
input.value=closures[i]||""
box.appendChild(input)
}
document.getElementById("popupClosures").style.display="flex"
}

function closeClosures(){document.getElementById("popupClosures").style.display="none"}
function forceSunday(dateStr){
  if(!dateStr) return dateStr;
  const d = new Date(dateStr);
  const day = d.getDay(); // 0 = dimanche
  if(day === 0) return dateStr;
  d.setDate(d.getDate() - day);
  return d.toISOString().slice(0,10);
}
function saveClosures(){
  let adjusted = false

  const inputs = [...document.querySelectorAll("#closuresInputs input")]

  closures = inputs
    .map(i => {
      const original = i.value
      const forced = forceSunday(i.value)
      if(original && original !== forced) adjusted = true
      return forced
    })
    .filter(v => v)
    .sort()

  localStorage.setItem(STORAGE.closures, JSON.stringify(closures))

  if(adjusted){
    alert("â„¹ï¸ Toute clÃ´ture doit Ãªtre un dimanche.\nLes dates saisies ont Ã©tÃ© automatiquement ajustÃ©es.")
  }

  buildPeriods()
  closeClosures()
}
function deletePeriod(i){
  if(!confirm("âŒ Supprimer cette pÃ©riode ? Elle sera ignorÃ©e mais conservÃ©e.")) return;

  periodMeta[i] = { status: "deleted" }
  localStorage.setItem(STORAGE.periodMeta, JSON.stringify(periodMeta))
  update()
}
function buildPeriods(){
  const base = getBaseStartDate();
  if(!base){
    update(); // ğŸ”¥ afficher le calendrier mÃªme sans exercice
    return;
  }

  periodSelect.innerHTML = "";

  let start = new Date(base);
  let today = new Date();
  today.setHours(0,0,0,0);

  let foundIndex = null;

  closures.forEach((c, i) => {
    const end = new Date(c);
    end.setHours(0,0,0,0);

    const opt = document.createElement("option");
    opt.value = i;
    opt.textContent = `${start.toLocaleDateString()} â†’ ${end.toLocaleDateString()}`;
    periodSelect.appendChild(opt);

    if (today >= start && today <= end) {
      foundIndex = i;
    }

    start = new Date(end);
    start.setDate(start.getDate() + 1);
  });

  // ğŸ‘‰ si aujourdâ€™hui est aprÃ¨s la derniÃ¨re clÃ´ture

if (closures.length === 0) {
  foundIndex = 0;
} else if (foundIndex === null) {
  foundIndex = closures.length - 1;
}

foundIndex = Math.max(0, foundIndex);

currentPeriodIndex = foundIndex;
periodSelect.selectedIndex = foundIndex;

update();
}

function toggleConfigLock(){
  const key = "CONFIG_LOCK_" + currentSuffix;
  const locked = localStorage.getItem(key) === "true";
  localStorage.setItem(key, !locked);
  applyConfigLock();
}

function applyConfigLock(){
  const locked =
    localStorage.getItem("CONFIG_LOCK_" + currentSuffix) === "true";

  document.querySelectorAll(
    "#exerciseStartInput, #baseHebdoInput, #annualDateInput"
  ).forEach(el => el.disabled = locked);

  const info = document.getElementById("configLockInfo");
  if(info){
    info.textContent = locked
      ? "ğŸ”’ Configuration verrouillÃ©e"
      : "ğŸ”“ Configuration modifiable";
  }
}
function getCurrentPeriod(){
  let start = getBaseStartDate()

  for(let i = 0; i <= closures.length; i++){
    const end = i < closures.length ? new Date(closures[i]) : new Date(2099,11,31)
    if(i === currentPeriodIndex){
      return { start, end, index: i }
    }
    start = new Date(end)
    start.setDate(start.getDate() + 1)
  }
  return null
}
function ensureReportsUpTo(index){
  for(let i = 0; i < index; i++){
    if(reports[i] === undefined){
      // forcer calcul de la pÃ©riode i
      const savedIndex = currentPeriodIndex
      currentPeriodIndex = i
      calculate()
      currentPeriodIndex = savedIndex
    }
  }
}
function generateCalendar(){
  calendar.innerHTML = ""

  const firstDay = new Date(viewYear, viewMonth, 1).getDay()
  const offset = firstDay === 0 ? 6 : firstDay - 1
  const days = new Date(viewYear, viewMonth + 1, 0).getDate()

  for(let i = 0; i < offset; i++){
    calendar.appendChild(document.createElement("div"))
  }

  const period = getCurrentPeriod()
  let pStart = null, pEnd = null

  if(period){
    pStart = new Date(period.start)
    pEnd = new Date(period.end)
    pStart.setHours(0,0,0,0)
    pEnd.setHours(0,0,0,0)
  }

  for(let d = 1; d <= days; d++){
    const key = `${viewYear}-${String(viewMonth+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`
    const div = document.createElement("div")
    div.className = "day"

    if(period){
      const dk = new Date(key)
      if(pStart && dk >= pStart && dk <= pEnd){
        div.classList.add("in-period")
      }
    }

    const day = data[key] || { extra:0, recup:0, absent:0 }
    let html = `<strong>${d}</strong>`

    if(day.extra){
      html += `<small style="color:#1976d2">+${day.extra}h</small>`
    }

    if(day.recup){
      html += `<small style="color:#ef6c00">-${day.recup}h</small>`
    }

    if (specialDays[key] === "ferie") {
      html += `<small style="color:#0d47a1;font-weight:bold">ğŸŒ FÃ©riÃ©</small>`
      div.style.background = "#e3f2fd"
      div.style.border = "2px dashed #1976d2"
    }
    else if (day.absent) {
      html += `<small style="color:#c62828;font-weight:bold">ABS ${day.absent}h</small>`
      div.style.background = "#ffebee"
      div.style.border = "2px solid #c62828"
    }

    div.innerHTML = html

    if(key === dateKeyLocal(new Date())){
      div.classList.add("today")
    }

    div.onclick = () => openPopup(key)
    calendar.appendChild(div)
  }
}
function getLastValidReport(index) {
  for (let i = index - 1; i >= 0; i--) {
    if (reports[i] !== undefined && reports[i] !== null) {
      return Number(reports[i]) || 0;
    }
  }
  return 0;
}
function calculate(){

  const period = getCurrentPeriod()
  if(!period){
    totaux.innerHTML = `
      <div style="background:#fff3cd;border:1px solid #ffeeba;padding:12px;border-radius:8px;color:#856404">
        â„¹ï¸ DÃ©finissez une date de dÃ©but dâ€™exercice et des clÃ´tures
        pour activer les calculs.
      </div>
    `
    return
  }

  let weeks = {}
let absences = {}
let totalRecup = 0
let recups = {}
let feries = {} // â¬…ï¸ ICI
let details = []
let h25 = 0
let h50 = 0

  
  if(periodMeta[period.index]?.status === "deleted"){
  totaux.innerHTML = "<i>âŒ Cette pÃ©riode est supprimÃ©e</i>"
  return
}

  // âœ… CORRECTION IMAGE 4 : SÃ©curisation du reportPrev contre les valeurs NaN ou vides
ensureReportsUpTo(period.index)
const reportPrev = getLastValidReport(period.index)

  periodInfo.innerHTML=`<b>PÃ©riode :</b> ${period.start.toLocaleDateString()} â†’ ${period.end.getFullYear()===2099?"en cours":period.end.toLocaleDateString()}<br>
  <b>Report prÃ©cÃ©dent :</b> ${reportPrev.toFixed(2)} h`
// ğŸ”’ Normalisation des bornes de pÃ©riode
const pStart = new Date(period.start)
const pEnd = new Date(period.end)
pStart.setHours(0,0,0,0)
pEnd.setHours(0,0,0,0)
// --- 1. TRAITEMENT DES DONNÃ‰ES (HEBDOMADAIRE) ---
Object.entries(data).forEach(([date, v]) => {

  const [y, m, d] = date.split("-").map(Number)
  const dayDate = new Date(y, m - 1, d)
  const dayOfWeek = dayDate.getDay() // 0 = dim

  if (dayDate < pStart || dayDate > pEnd) return

// ğŸ“… Lundi de la semaine
const isoDay = dayOfWeek === 0 ? 7 : dayOfWeek
const monday = new Date(dayDate)
monday.setDate(monday.getDate() - (isoDay - 1))

// âŒ ignorer les semaines dont le lundi est hors pÃ©riode
if (monday < pStart || monday > pEnd) {
  return
}
// âœ… semaine valide â†’ on peut crÃ©er la clÃ©
const weekKey = dateKeyLocal(monday)

  // ğŸŒ FÃ‰RIÃ‰ = absence automatique 7h (jours ouvrÃ©s)
  let absentHours = v.absent || 0
  if (
    specialDays[date] === "ferie" &&
    dayOfWeek !== 0 &&
    dayOfWeek !== 6
  ) {
    absentHours = DAILY_WORK_HOURS
    feries[weekKey] = (feries[weekKey] || 0) + DAILY_WORK_HOURS
  }

  // â• Heures effectuÃ©es au-delÃ  de la base ajustÃ©e
  weeks[weekKey] = (weeks[weekKey] || 0) + (v.extra || 0)

  // âŒ Absences (inclut fÃ©riÃ© car transformÃ© en absence)
  if (dayOfWeek !== 0 && dayOfWeek !== 6) {
    absences[weekKey] = (absences[weekKey] || 0) + absentHours
  }

  // ğŸ” RÃ©cupÃ©rations
  recups[weekKey] = (recups[weekKey] || 0) + (v.recup || 0)
  totalRecup += v.recup || 0
})

  // --- 2. CALCUL DES MAJORATIONS (RÃˆGLE DÃ‰FINITIVE) ---
Object.entries(weeks).forEach(([week, extra]) => {
  const absent = absences[week] || 0;
  const recup = recups[week] || 0;


// base juridique = heures rÃ©ellement travaillables
const base = Math.max(
  0,
  BASE_HEBDO - absent - recup
);
  const total = base + extra;

  let w25 = 0;
  let w50 = 0;

  // ğŸ”¹ 25 % : dÃ¨s qu'on dÃ©passe 35h jusqu'Ã  43h inclus
  if (total > BASE_HEBDO) {
  w25 = Math.min(total, BASE_HEBDO + 8) - BASE_HEBDO;
}

  // ğŸ”¹ 50 % : dÃ¨s qu'on dÃ©passe 43h
  if (total > BASE_HEBDO + 8) {
  w50 = total - (BASE_HEBDO + 8);
}

  // SÃ©curisation
  w25 = Math.max(0, w25);
  w50 = Math.max(0, w50);

  h25 += w25;
  h50 += w50;

  // (optionnel) dÃ©tail affichage
  const [y, m, d] = week.split("-");
  const weekDate = new Date(y, m - 1, d);
  details.push(
    `Semaine du ${weekDate.toLocaleDateString()} : ${w25.toFixed(2)}h Ã  25% / ${w50.toFixed(2)}h Ã  50%`
  );
});
    
    // âœ… CORRECTION IMAGE 3 : Affichage sans bug UTC pour la date de 

  const brut25 = h25 * 1.25;
  const brut50 = h50 * 1.5;
  const brut = brut25 + brut50 + reportPrev;
  const net = brut - totalRecup;
reports[period.index] = net;
localStorage.setItem(STORAGE.reports, JSON.stringify(reports));

  // --- 3. AFFICHAGE HTML ---
  totaux.innerHTML = `
  <details class="calc-details">
    <summary>ğŸ“Š DÃ©tails des calculs</summary>
    <div class="breakdown">
      ${details.join("<br>")}
      <hr>
      25% : ${h25}h Ã— 1,25 = ${brut25.toFixed(2)} h<br>
      50% : ${h50}h Ã— 1,50 = ${brut50.toFixed(2)} h<br>
      Report prÃ©cÃ©dent : ${reportPrev.toFixed(2)} h
    </div>
  </details>
  <hr>
  <b>Solde brut :</b> ${brut.toFixed(2)} h<br>
  RÃ©cup : ${totalRecup.toFixed(2)} h<br>
  <b>Solde net :</b> ${net.toFixed(2)} h
  `;

  // --- 4. TAUX ET CLÃ”TURE (IMAGE 5 - Toujours avec 10â‚¬ par dÃ©faut) ---
  const rateContainer = document.getElementById("rateContainer");
  rateContainer.innerHTML = "";

  if (shouldShowAnnualClosure()) {
    rateContainer.innerHTML = `
      <div style="background:#fff3e0;padding:10px;border-radius:6px;border:1px solid #ff9800;margin-top:10px;">
        <label><b>Taux horaire (â‚¬)</b></label>
        <input type="number" id="hourlyRateInput" step="0.5"
        value="${annualRate}"
   oninput="annualRate = Number(this.value) || 10;
localStorage.setItem('ANNUAL_RATE_' + currentSuffix, annualRate);
calculate()"
      </div>`;

    const rate = annualRate || 10;
    const paiement = net * rate;

    // RÃ©capitulatif absences/fÃ©riÃ©s annuel
    let annAbsH = 0, annAbsD = 0, annFerH = 0, annFerD = 0;
    const limit = annualDate ? new Date(annualDate) : null;
    
    Object.entries(data).forEach(([date, v]) => {
      const parts = date.split('-');
      const d = new Date(parts[0], parts[1]-1, parts[2]);
      const dayOfWeek = d.getDay(); // 0 = dim, 6 = sam

if (
  limit &&
  d <= limit &&
  dayOfWeek !== 0 &&
  dayOfWeek !== 6
) {
        const abs = v.absent || 0;
        if(abs > 0){
          if(specialDays[date] === "ferie"){
            annFerD++; annFerH += abs;
          } else {
            annAbsH += abs;
            if(abs >= 7) annAbsD++;
          }
        }
      }
    });

    totaux.innerHTML += `
      <hr>
      <div style="background:#e8f5e9;padding:15px;border:2px solid #2e7d32;border-radius:8px;">
        <h3 style="margin:0;color:#2e7d32;">ğŸ¯ ClÃ´ture Annuelle</h3>
        <b>Paiement (${rate}â‚¬/h) :</b> ${paiement.toFixed(2)} â‚¬
      </div>`;
  }
}
function openNotice(){
  document.getElementById("popupNotice").style.display = "flex";
}

function closeNotice(){
  document.getElementById("popupNotice").style.display = "none";
}
function openPopup(date){
  selectedDate = date

  // â„¹ï¸ Info non bloquante si exercice non dÃ©fini
  if(!exerciseStart){
    console.warn("Date de dÃ©but dâ€™exercice non dÃ©finie")
  }

  // ğŸŒ FÃ‰RIÃ‰ = absence forcÃ©e 7h
  if (specialDays[date] === "ferie") {
    if (!data[date]) data[date] = {extra:0, recup:0, absent:0}
    data[date].absent = DAILY_WORK_HOURS
  }

  const d = data[date] || {extra:0, recup:0, absent:0}

  popupDate.textContent = date
  manualExtra.value = d.extra
  manualRecup.value = d.recup
  absentHours.value = d.absent || 0
  isAbsent.checked = (d.absent || 0) > 0
document.body.style.overflow = "hidden";
  popup.style.display = "flex"
}
function closePopup(){
  document.getElementById("popup").style.display = "none";
  selectedDate = "";   // ğŸ”¥ FIX CRITIQUE
document.body.style.overflow = "";
  update();
}





function save(){
  localStorage.setItem(STORAGE.data, JSON.stringify(data));

  const stamp = new Date().toISOString();
  localStorage.setItem("AUTO_SAVE_DATE_" + currentSuffix, stamp);

  updateSaveBadges();
}

function isIOS(){return /iPad|iPhone|iPod/.test(navigator.userAgent)}

function exportJSON(){
  const payload = {
    version: 1,                // âœ… version
    exercise: currentSuffix,   // âœ… annÃ©e dâ€™exercice
    data,
    closures,
    reports,
    periodMeta,
    exerciseStart,
    annualDate,
    specialDays,
    BASE_HEBDO,
    annualRate
  }
  const json = JSON.stringify(payload, null, 2)
  const blob = new Blob([json], { type: "application/json" })
  const filename = `heures_sup_${currentSuffix}.json`

  // ğŸŒ iOS + Android rÃ©cents â†’ feuille de partage
  if (navigator.canShare && navigator.canShare({ files: [new File([blob], filename)] })) {
  const stamp = new Date().toISOString()
  localStorage.setItem("FILE_SAVE_DATE_" + currentSuffix, stamp)
  updateSaveBadges()

  const file = new File([blob], filename, { type: "application/json" })
  navigator.share({
    files: [file],
    title: "Sauvegarde heures supplÃ©mentaires"
  })
  return
}

  // ğŸ’» PC / Mac / anciens navigateurs â†’ tÃ©lÃ©chargement
  const url = URL.createObjectURL(blob)
  const a = document.createElement("a")
  a.href = url
  a.download = filename
  document.body.appendChild(a)
  a.click()
  document.body.removeChild(a)
  URL.revokeObjectURL(url)
  const stamp = new Date().toISOString()
localStorage.setItem("FILE_SAVE_DATE_" + currentSuffix, stamp)
updateSaveBadges()
}


function importJSON(){
if(isIOS()){
jsonTitle.textContent = "Collez le texte JSON (Import)"
jsonArea.value = ""
popupJSON.style.display = "flex"
}else{
const input = document.createElement("input")
input.type = "file"
input.accept = ".json"
input.onchange = e => {
const reader = new FileReader()
reader.onload = () => loadJSON(reader.result)
reader.readAsText(e.target.files[0])
}
input.click()
}
}
function updateSaveBadges(){
  const autoEl = document.getElementById("autoSaveBadge")
  const fileEl = document.getElementById("fileSaveBadge")

  if(!autoEl || !fileEl) return

  const auto = localStorage.getItem("AUTO_SAVE_DATE_" + currentSuffix)
  const file = localStorage.getItem("FILE_SAVE_DATE_" + currentSuffix)

  autoEl.textContent = auto
  ? "ğŸŸ¢ Dans lâ€™application : " + new Date(auto).toLocaleString()
  : "ğŸŸ¢ Dans lâ€™application : â€”"

fileEl.textContent = file
  ? "ğŸ’¾ Sauvegarde fichier : " + new Date(file).toLocaleString()
  : "ğŸ’¾ Sauvegarde fichier : â€”"
  }
function confirmImportJSON(){loadJSON(jsonArea.value);closeJSONPopup()}

function loadJSON(text){
  let obj;

  // 1ï¸âƒ£ Parsing sÃ©curisÃ©
  try {
    obj = JSON.parse(text);
  } catch(e){
    alert("âŒ JSON invalide");
    return;
  }

  // 2ï¸âƒ£ VÃ©rification version
  if(obj.version !== 1){
    alert("âŒ Version de sauvegarde incompatible");
    return;
  }

  // 3ï¸âƒ£ VÃ©rification exercice (ANNÃ‰E)
  if(obj.exercise && String(obj.exercise) !== String(currentSuffix)){
    const ok = confirm(
      `âš ï¸ Ce fichier appartient Ã  lâ€™exercice ${obj.exercise}.\n\n` +
      `Voulez-vous basculer automatiquement dessus ?`
    );
    if(!ok) return;

    localStorage.setItem("ACTIVE_YEAR_SUFFIX", obj.exercise);
    location.reload();
    return;
  }

  // 4ï¸âƒ£ VÃ©rification contenu minimal
  if(!obj.data || !obj.closures){
    alert("âŒ Sauvegarde invalide ou incomplÃ¨te");
    return;
  }

  // 5ï¸âƒ£ Confirmation utilisateur
  if(!confirm(
    "âš ï¸ Cette action va remplacer les donnÃ©es de lâ€™exercice en cours.\n\nContinuer ?"
  )){
    return;
  }

  // 6ï¸âƒ£ Import rÃ©el (SANS RISQUE Dâ€™Ã‰CRASER UNE AUTRE ANNÃ‰E)
  data = obj.data;
  closures = obj.closures;
  reports = obj.reports || {};
  periodMeta = obj.periodMeta || {};
  exerciseStart = obj.exerciseStart || "";
  annualDate = obj.annualDate || "";
  specialDays = obj.specialDays || {};

  BASE_HEBDO = Number(obj.BASE_HEBDO) || 35;
  annualRate = Number(obj.annualRate) || 10;

  // 7ï¸âƒ£ Sauvegarde STRICTEMENT sur lâ€™exercice actif
  localStorage.setItem(STORAGE.data, JSON.stringify(data));
  localStorage.setItem(STORAGE.closures, JSON.stringify(closures));
  localStorage.setItem(STORAGE.reports, JSON.stringify(reports));
  localStorage.setItem(STORAGE.periodMeta, JSON.stringify(periodMeta));
  localStorage.setItem(STORAGE.exerciseStart, exerciseStart);
  localStorage.setItem(STORAGE.annualDate, annualDate);
  localStorage.setItem(STORAGE.specialDays, JSON.stringify(specialDays));
  localStorage.setItem("BASE_HEBDO_" + currentSuffix, BASE_HEBDO);
  localStorage.setItem("ANNUAL_RATE_" + currentSuffix, annualRate);

  update();
  alert("âœ… Import complet rÃ©ussi");
}

function closeJSONPopup(){popupJSON.style.display = "none"}

async function importFeries(){
  const baseYear = Number(currentSuffix);
  const years = [baseYear - 1, baseYear, baseYear + 1];

  if(!confirm(
    `Importer les jours fÃ©riÃ©s officiels pour ${years.join(", ")} ?`
  )) return;

  try{
    for(const year of years){
      const res = await fetch(
        `https://calendrier.api.gouv.fr/jours-feries/metropole/${year}.json`
      );
      const feries = await res.json();

      Object.keys(feries).forEach(date=>{
        // marquer comme fÃ©riÃ© (sans Ã©craser)
        if(!specialDays[date]){
          specialDays[date] = "ferie";
        }
      });
    }

    localStorage.setItem(STORAGE.specialDays, JSON.stringify(specialDays));
    localStorage.setItem(STORAGE.data, JSON.stringify(data));

    update();
    alert("âœ… Jours fÃ©riÃ©s importÃ©s (N-1 / N / N+1)");
  }catch(e){
    alert("âŒ Impossible dâ€™importer les jours fÃ©riÃ©s");
  }
}
function update(){
  checkExerciseStartAlert()
  generateCalendar()
  calculate()
  applyConfigLock()
  updateSaveBadges()

  // ğŸ”” Bandeau pÃ©riode active
  const banner = document.getElementById("activePeriodBanner")
  const period = getCurrentPeriod()

  if(banner){
    if(period && exerciseStart){
      const start = period.start.toLocaleDateString()
      const end = period.end.getFullYear() === 2099
        ? "en cours"
        : period.end.toLocaleDateString()

      banner.innerHTML =
  `ğŸ“˜ PÃ©riode ${period.index + 1} : ${start} â†’ ${end}`;
    } else {
      banner.innerHTML = ""
    }
  }
}
monthSelect.onchange = () => {
  viewMonth = +monthSelect.value;
  update(); // ğŸ”¥ recalcul complet (calendrier + soldes + clÃ´ture annuelle)
};

yearSelect.onchange = () => {
  viewYear = +yearSelect.value;
  update(); // ğŸ”¥ recalcul complet
};
periodSelect.onchange = () => {
  currentPeriodIndex = +periodSelect.value;
  update();
  showToast();
};


const annualDateInput = document.getElementById("annualDateInput");
annualDateInput.value = annualDate;

annualDateInput.onchange = () => {
  annualDate = forceSunday(annualDateInput.value);
  annualDateInput.value = annualDate;
  localStorage.setItem(STORAGE.annualDate, annualDate);
};
const exerciseStartInput = document.getElementById("exerciseStartInput");
exerciseStartInput.value = exerciseStart;
const baseHebdoInput = document.getElementById("baseHebdoInput");
baseHebdoInput.value = BASE_HEBDO;

baseHebdoInput.oninput = () => {
  BASE_HEBDO = Number(baseHebdoInput.value) || 35;
  localStorage.setItem("BASE_HEBDO_" + currentSuffix, BASE_HEBDO);
  update();
};
exerciseStartInput.onchange = ()=>{
  exerciseStart = exerciseStartInput.value;
  localStorage.setItem(STORAGE.exerciseStart, exerciseStart);
  buildPeriods();
};

  // ===== FONCTION DE VÃ‰RIFICATION DU MOIS EXACT =====
function exportMonthlyFullPDF(){
  const { jsPDF } = window.jspdf
  const pdf = new jsPDF()

  const title = `Compteur annuel dâ€™heures â€“ RÃ©capitulatif mensuel`
  const monthName = months[viewMonth]

  let y = 15
  pdf.setFontSize(14)
  pdf.text(title, 10, y)
  y += 10

  pdf.setFontSize(10)
  pdf.text(`Mois : ${monthName} ${viewYear}`, 10, y); y+=6
  pdf.text(`Base hebdomadaire : ${BASE_HEBDO} h`, 10, y); y+=6
const period = getCurrentPeriod();
if(period){
  pdf.text(
    "PÃ©riode comptable : pÃ©riode active au moment de lâ€™export",
    10, y
  );
  y += 6;
}
  pdf.line(10, y, 200, y)
  y += 8

  let weeks = {}
  let absences = {}
  let recups = {}
  let feries = {}

  Object.entries(data).forEach(([date, v])=>{
    const d = new Date(date)
    if(d.getFullYear() !== viewYear || d.getMonth() !== viewMonth) return

    const day = d.getDay()
    const iso = day === 0 ? 7 : day
    const monday = new Date(d)
    monday.setDate(monday.getDate() - (iso - 1))
    const wk = dateKeyLocal(monday)

    weeks[wk] = (weeks[wk] || 0) + (v.extra || 0)
    recups[wk] = (recups[wk] || 0) + (v.recup || 0)

    if(day !== 0 && day !== 6){
      absences[wk] = (absences[wk] || 0) + (v.absent || 0)
    }

    if(specialDays[date] === "ferie"){
      feries[wk] = (feries[wk] || 0) + DAILY_WORK_HOURS
    }
  })

  let t25=0, t50=0, tRec=0

  Object.keys(weeks).sort().forEach(w=>{
    const base = Math.max(0, BASE_HEBDO - (absences[w]||0) - (recups[w]||0))
    const total = base + weeks[w]

    let h25 = 0, h50 = 0
    if(total > BASE_HEBDO) h25 = Math.min(total, BASE_HEBDO+8)-BASE_HEBDO
    if(total > BASE_HEBDO+8) h50 = total-(BASE_HEBDO+8)

    t25 += Math.max(0,h25)
    t50 += Math.max(0,h50)
    tRec += recups[w]||0

    pdf.text(
      `Semaine du ${new Date(w).toLocaleDateString()} : ${h25.toFixed(2)}h 25% / ${h50.toFixed(2)}h 50%`,
      10, y
    )
    y+=6
    if(y>270){pdf.addPage();y=15}
  })

  y+=6
  pdf.line(10,y,200,y);y+=8
  pdf.text(`Total 25 % : ${t25.toFixed(2)} h`,10,y);y+=6
  pdf.text(`Total 50 % : ${t50.toFixed(2)} h`,10,y);y+=6
  pdf.text(`RÃ©cupÃ©rations : ${tRec.toFixed(2)} h`,10,y)

  y+=10
  pdf.setFontSize(8)
  pdf.text("Document informatif â€“ ne constitue pas un bulletin de paie.",10,y)

  pdf.save(`mensuel_${monthName}_${viewYear}.pdf`)
}
function exportAnnualPDF(){
  const { jsPDF } = window.jspdf
  const pdf = new jsPDF()

  let y = 15

  const addHeader = (title) => {
    pdf.setFontSize(14)
    pdf.text(title, 10, y)
    y += 8
    pdf.setFontSize(10)
    pdf.text(`Exercice : ${currentSuffix}`, 10, y)
    y += 8
    pdf.line(10, y, 200, y)
    y += 6
  }

  addHeader("Compteur annuel dâ€™heures â€“ Bilan annuel")

  let annualNet = 0

  closures.forEach((_, index) => {

    const period = (() => {
      let start = getBaseStartDate()
      for(let i=0;i<=closures.length;i++){
        const end = i < closures.length
          ? new Date(closures[i])
          : new Date(2099,11,31)
        if(i === index){
          return { start, end, index:i }
        }
        start = new Date(end)
        start.setDate(start.getDate()+1)
      }
      return null
    })()

    if(!period) return
    if(periodMeta[index]?.status === "deleted") return

    if(y > 230){
      pdf.addPage()
      y = 15
      addHeader("Suite â€“ Bilan annuel")
    }

    pdf.setFontSize(12)
    pdf.text(
      `ğŸ“˜ PÃ©riode ${index + 1} : ${period.start.toLocaleDateString()} â†’ ${
        period.end.getFullYear() === 2099 ? "en cours" : period.end.toLocaleDateString()
      }`,
      10, y
    )
    y += 6

    pdf.setFontSize(9)
    pdf.text(
  `Base hebdomadaire : ${BASE_HEBDO} h`,
  10, y
)
    y += 5

    let weeks = {}
    let absences = {}
    let recups = {}

    Object.entries(data).forEach(([date, v])=>{
      const d = new Date(date)
      if(d < period.start || d > period.end) return

      const day = d.getDay()
      const iso = day === 0 ? 7 : day
      const monday = new Date(d)
      monday.setDate(monday.getDate() - (iso - 1))
      const wk = dateKeyLocal(monday)

      weeks[wk] = (weeks[wk] || 0) + (v.extra || 0)
      recups[wk] = (recups[wk] || 0) + (v.recup || 0)

      if(day !== 0 && day !== 6){
        absences[wk] = (absences[wk] || 0) + (v.absent || 0)
      }
    })

    let p25 = 0, p50 = 0, pRec = 0

    Object.keys(weeks).sort().forEach(w=>{
      const base = Math.max(
        0,
        BASE_HEBDO - (absences[w]||0) - (recups[w]||0)
      )
      const total = base + weeks[w]

      let h25 = 0, h50 = 0
      if(total > BASE_HEBDO) h25 = Math.min(total, BASE_HEBDO+8)-BASE_HEBDO
      if(total > BASE_HEBDO+8) h50 = total-(BASE_HEBDO+8)

      p25 += Math.max(0,h25)
      p50 += Math.max(0,h50)
      pRec += recups[w]||0

      pdf.text(
        `â€¢ Semaine du ${new Date(w).toLocaleDateString()} : ${h25.toFixed(2)}h 25% / ${h50.toFixed(2)}h 50%`,
        12, y
      )
      y += 4

      if(y > 270){
        pdf.addPage()
        y = 15
      }
    })

    const reportPrev = getLastValidReport(index)
    const brut = p25*1.25 + p50*1.5 + reportPrev
    const net = brut - pRec

annualNet += net

    y += 4
    pdf.text(`Total 25 % : ${p25.toFixed(2)} h`, 12, y); y+=4
    pdf.text(`Total 50 % : ${p50.toFixed(2)} h`, 12, y); y+=4
    pdf.text(`RÃ©cupÃ©rations : ${pRec.toFixed(2)} h`, 12, y); y+=4
    pdf.text(`Solde net de pÃ©riode : ${net.toFixed(2)} h`, 12, y); y+=6

    pdf.line(10, y, 200, y)
    y += 6
  })

  if(y > 240){
    pdf.addPage()
    y = 15
  }

  pdf.setFontSize(14)
  pdf.text("ğŸ“Š SynthÃ¨se annuelle", 10, y)
  y += 10

  pdf.setFontSize(12)
  pdf.text(`Solde annuel net cumulÃ© : ${annualNet.toFixed(2)} h`, 10, y)
  y += 14

  pdf.setFontSize(10)
  pdf.text("Validation / Signature :", 10, y)
  y += 10
  pdf.rect(10, y, 90, 20)

  y += 30
  pdf.setFontSize(8)
  pdf.text(
  "Bilan annuel gÃ©nÃ©rÃ© automatiquement.\nDocument indicatif â€“ ne constitue pas un bulletin de paie.",
  10,
  y
)

pdf.save(`annuel_${currentSuffix}.pdf`)
}
function exportPeriodPDF(){
  const { jsPDF } = window.jspdf
  const pdf = new jsPDF()

  const period = getCurrentPeriod()
  if(!period){
    alert("âŒ Aucune pÃ©riode active")
    return
  }

  const title = "Compteur annuel dâ€™heures â€“ RÃ©capitulatif de pÃ©riode"

  let y = 15
  pdf.setFontSize(14)
  pdf.text(title, 10, y)

  y += 10
  pdf.setFontSize(10)

  pdf.text(
  `PÃ©riode : ${period.start.toLocaleDateString()} â†’ ${
    period.end.getFullYear() === 2099
      ? "en cours"
      : period.end.toLocaleDateString()
  }`,
  10,
  y
);
y += 6;
  pdf.text(`Base hebdomadaire : ${BASE_HEBDO} h`, 10, y)

  y += 6
    

  y += 8
  pdf.line(10, y, 200, y)
  y += 6

  // ğŸ”¢ DonnÃ©es hebdomadaires
  let weeks = {}
  let absences = {}
  let recups = {}
  let feries = {}

  Object.entries(data).forEach(([date, v])=>{
    const d = new Date(date)
    if(d < period.start || d > period.end) return

    const day = d.getDay()
    const isoDay = day === 0 ? 7 : day
    const monday = new Date(d)
    monday.setDate(monday.getDate() - (isoDay - 1))
    const wk = dateKeyLocal(monday)

    weeks[wk] = (weeks[wk] || 0) + (v.extra || 0)
    recups[wk] = (recups[wk] || 0) + (v.recup || 0)

    if(day !== 0 && day !== 6){
      absences[wk] = (absences[wk] || 0) + (v.absent || 0)
    }

    if(specialDays[date] === "ferie"){
      feries[wk] = (feries[wk] || 0) + DAILY_WORK_HOURS
    }
  })

  let total25 = 0
  let total50 = 0
  let totalRecup = 0

  Object.keys(weeks).sort().forEach(week=>{
    const base = Math.max(
      0,
      BASE_HEBDO - (absences[week] || 0) - (recups[week] || 0)
    )
    const total = base + weeks[week]

    let h25 = 0
    let h50 = 0

    if(total > BASE_HEBDO){
      h25 = Math.min(total, BASE_HEBDO + 8) - BASE_HEBDO
    }
    if(total > BASE_HEBDO + 8){
      h50 = total - (BASE_HEBDO + 8)
    }

    total25 += Math.max(0, h25)
    total50 += Math.max(0, h50)
    totalRecup += recups[week] || 0

    const d = new Date(week)
    pdf.text(
      `Semaine du ${d.toLocaleDateString()} : ${h25.toFixed(2)}h Ã  25% / ${h50.toFixed(2)}h Ã  50%`,
      10,
      y
    )
    y += 6

    if(y > 270){
      pdf.addPage()
      y = 15
    }
  })

  const reportPrev = getLastValidReport(period.index)
  const brut = total25 * 1.25 + total50 * 1.5 + reportPrev
  const net = brut - totalRecup

  y += 6
  pdf.line(10, y, 200, y)
  y += 8

  pdf.text(`Total 25 % : ${total25.toFixed(2)} h`, 10, y); y+=6
  pdf.text(`Total 50 % : ${total50.toFixed(2)} h`, 10, y); y+=6
  pdf.text(`RÃ©cupÃ©rations : ${totalRecup.toFixed(2)} h`, 10, y); y+=6
  pdf.text(`Report prÃ©cÃ©dent : ${reportPrev.toFixed(2)} h`, 10, y); y+=6

  pdf.setFontSize(12)
  pdf.text(`Solde net de pÃ©riode : ${net.toFixed(2)} h`, 10, y)
  y += 12

  pdf.setFontSize(10)
  pdf.text("Validation / Signature :", 10, y)
  y += 10
  pdf.rect(10, y, 90, 20)

  y += 30
  pdf.setFontSize(8)
  pdf.text(
    "Document gÃ©nÃ©rÃ© automatiquement Ã  titre informatif.\nNe constitue pas un bulletin de paie.",
    10,
    y
  )

  pdf.save(
    `periode_${period.start.toISOString().slice(0,10)}_${currentSuffix}.pdf`
  )
}
function shouldShowAnnualClosure() {
  if (!annualDate) return false;

  const ad = new Date(annualDate);

  return (
    ad.getFullYear() === viewYear &&
    ad.getMonth() === viewMonth
  );
}
function showToast(){
  const toast = document.getElementById("toast")
  if(!toast) return

  toast.style.opacity = "1"
  setTimeout(() => {
    toast.style.opacity = "0"
  }, 3000)
}
// ğŸ› ï¸ AmÃ©lioration du FIX Safari iOS
document.querySelectorAll("details.section").forEach(d => {
  d.addEventListener("toggle", () => {
    // On cible la zone qui bug
    const nav = document.querySelector(".month-nav");
    if (nav) {
      // Forcer un "repaint" complet
      nav.style.display = 'none';
      setTimeout(() => {
        nav.style.display = 'flex'; // On remet en flex comme dÃ©fini dans le CSS
      }, 10);
    }
  });
});

initSelectors()
applyConfigLock();
buildPeriods()
autoSwitchPeriodAtMidnight()

function openLegalPopup(){
  document.getElementById("popupLegal").style.display = "flex";
}

function closeLegalPopup(){
  document.getElementById("popupLegal").style.display = "none";
}
</script>
<div id="toast" style="
  position:fixed;
  bottom:20px;
  left:50%;
  transform:translateX(-50%);
  background:#323232;
  color:#fff;
  padding:10px 16px;
  border-radius:20px;
  font-size:14px;
  opacity:0;
  pointer-events:none;
  transition:opacity .4s;
  z-index:9999;
">
  ğŸ•› Nouvelle pÃ©riode activÃ©e automatiquement
</div>
<div class="popup" id="popupClosures">
  <div class="popup-content">
    <h3>ğŸ“… ClÃ´tures comptables</h3>
    <div id="closuresInputs"></div>
    <button onclick="saveClosures()">Enregistrer</button>
    <button onclick="closeClosures()">Fermer</button>
  </div>
</div>
<p style="text-align:center; font-size:12px; color:#666; margin-top:30px;">
  Â© Tous droits rÃ©servÃ©s C.Anthony Â·
  <a href="#" onclick="openLegalPopup()" style="margin-right:10px">
  â„¹ï¸ Informations lÃ©gales & calcul
</a>
<a href="#" onclick="openNotice()">
  ğŸ“˜ Notice utilisateur
</a>
</p>
<p style="
  max-width:900px;
  margin:20px auto;
  font-size:12px;
  color:#555;
  background:#fffde7;
  border:1px solid #ffe082;
  padding:12px;
  border-radius:8px;
  text-align:center;
">
  âš ï¸ <b>Sauvegarde des donnÃ©es</b><br><br>

  Les donnÃ©es saisies dans cette application sont enregistrÃ©es
  <b>localement sur cet appareil</b> (navigateur / tÃ©lÃ©phone / tablette).<br><br>

  Elles peuvent Ãªtre perdues en cas de suppression du navigateur,
  de changement dâ€™appareil, de rÃ©initialisation ou de nettoyage des donnÃ©es.<br><br>

  <b>Il est fortement recommandÃ© dâ€™effectuer des exports rÃ©guliers</b>
  (mensuels ou aprÃ¨s chaque clÃ´ture) afin de conserver une sauvegarde fiable
  de votre suivi annuel.
</p>
<!-- ğŸ”½ POPUP LÃ‰GAL -->
<div class="popup" id="popupLegal">
  <div class="popup-content" style="max-width:700px;max-height:80vh;overflow:auto;">
    <h3>â„¹ï¸ Informations lÃ©gales & rÃ¨gles de calcul</h3>


<p>
Cet outil a pour finalitÃ© dâ€™aider au suivi, Ã  lâ€™estimation et Ã  la comprÃ©hension
du temps de travail, des heures supplÃ©mentaires, des rÃ©cupÃ©rations et des soldes
horaires, Ã  partir des donnÃ©es saisies par lâ€™utilisateur.
</p>
<hr>
<p>
<b>Fonctionnement gÃ©nÃ©ral</b><br><br>
Cet outil fonctionne comme un <b>compteur annuel du temps de travail</b>.<br><br>
Lorsquâ€™une semaine nâ€™est pas complÃ¨te (absence ou rÃ©cupÃ©ration),
le nombre dâ€™heures attendues est automatiquement ajustÃ©.<br><br>
Les rÃ©cupÃ©rations sont assimilÃ©es Ã  du temps non travaillÃ© et
rÃ©duisent le volume hebdomadaire de rÃ©fÃ©rence dans le cadre
dâ€™un compteur annuel.<br><br>
Les heures supplÃ©mentaires ne sont jamais dÃ©clenchÃ©es avant
dâ€™avoir dÃ©passÃ© lâ€™Ã©quivalent de <b>35 heures rÃ©ellement travaillÃ©es</b>.
</p>
<hr>
<p>
Il sâ€™agit dâ€™un outil dâ€™aide au calcul et Ã  la lecture des donnÃ©es, dont les rÃ©sultats
sont fournis Ã  titre indicatif. Il ne constitue ni un logiciel de paie, ni un document
officiel, ni un support contractuel.
</p>

<hr>

<h4>âš–ï¸ Cadre juridique de rÃ©fÃ©rence</h4>

<p>
Les rÃ¨gles de calcul appliquÃ©es reposent sur les principes gÃ©nÃ©raux du Code du travail
et de la convention collective nationale du commerce de gros (IDCC 573), dans leur
version en vigueur au moment de lâ€™utilisation.
</p>

<p>
Ces rÃ¨gles sont susceptibles dâ€™Ã©voluer et peuvent Ãªtre amÃ©nagÃ©es par des accords
dâ€™entreprise, des usages internes ou des dispositions contractuelles spÃ©cifiques,
qui ne peuvent Ãªtre intÃ©grÃ©s automatiquement par lâ€™outil.
</p>

<hr>

<h4>ğŸŒ Jours fÃ©riÃ©s</h4>

<p>
Lorsquâ€™un jour fÃ©riÃ© est chÃ´mÃ© et payÃ©, il ouvre droit au maintien de la rÃ©munÃ©ration
lorsque les conditions lÃ©gales et conventionnelles sont remplies.
</p>

<p>
Un jour fÃ©riÃ© chÃ´mÃ© et payÃ© ne constitue pas du temps de travail effectif. Il nâ€™est
pas assimilÃ© Ã  une absence et ne doit pas entraÃ®ner de pÃ©nalisation du salariÃ©.
</p>

<p>
Dans le calcul hebdomadaire, la prÃ©sence dâ€™un jour fÃ©riÃ© chÃ´mÃ© entraÃ®ne une rÃ©duction
du temps de travail attendu (par dÃ©faut 7 heures pour une journÃ©e complÃ¨te), sans
modifier le seuil lÃ©gal de dÃ©clenchement des heures supplÃ©mentaires.
</p>

<p>
Les heures supplÃ©mentaires sont dÃ©clenchÃ©es uniquement Ã  partir de la
<b>36áµ‰ heure rÃ©ellement travaillÃ©e</b> dans la semaine, y compris lorsquâ€™un ou plusieurs
jours fÃ©riÃ©s sont prÃ©sents.
</p>

<hr>

<h4>âŒ Absences</h4>

<p>
Les absences correspondent Ã  des pÃ©riodes non travaillÃ©es imputables au salariÃ©
(congÃ©s sans solde, absences injustifiÃ©es, absences autorisÃ©es non assimilÃ©es Ã  du
temps de travail effectif, selon les paramÃ¨tres saisis).
</p>

<p>
Les absences sont prises en compte uniquement sur les jours ouvrÃ©s et rÃ©duisent
le volume dâ€™heures travaillables servant de base au calcul hebdomadaire.
</p>

<p>
Les jours fÃ©riÃ©s chÃ´mÃ©s et payÃ©s ne sont pas comptabilisÃ©s comme des absences.
</p>

<hr>

<h4>ğŸ” RÃ©cupÃ©rations</h4>

<p>
Les rÃ©cupÃ©rations correspondent Ã  des heures prÃ©cÃ©demment travaillÃ©es et ultÃ©rieurement
non travaillÃ©es. Elles sont traitÃ©es comme du temps non travaillÃ© sur la pÃ©riode
concernÃ©e.
</p>

<p>
Les rÃ©cupÃ©rations rÃ©duisent le solde horaire final et peuvent Ã©galement diminuer
le volume dâ€™heures travaillables dans la semaine selon le paramÃ©trage retenu.
</p>

<hr>

<h4>â• Heures supplÃ©mentaires</h4>

<p>
Les heures supplÃ©mentaires sont calculÃ©es dans une logique de
compteur annuel, Ã  partir des heures rÃ©ellement travaillÃ©es.
</p>

<p>
Le seuil de dÃ©clenchement correspond Ã  lâ€™Ã©quivalent de
35 heures hebdomadaires, ajustÃ© selon les absences
et les rÃ©cupÃ©rations.
</p>

<p>
Les majorations sont calculÃ©es selon les seuils lÃ©gaux en vigueur :
</p>

<ul>
  <li>Heures de la 36áµ‰ Ã  la 43áµ‰ heure : majoration de 25 %</li>
  <li>Heures au-delÃ  de la 43áµ‰ heure : majoration de 50 %</li>
</ul>

<p>
Seules les heures rÃ©ellement travaillÃ©es sont prises en compte pour le dÃ©clenchement
des heures supplÃ©mentaires.
</p>

<hr>

<h4>âš ï¸ Limites, paramÃ©trage et responsabilitÃ©</h4>

<p>
MalgrÃ© le soin apportÃ© Ã  sa conception, cet outil peut comporter des limites,
des erreurs de paramÃ©trage, des imprÃ©cisions ou des dysfonctionnements techniques,
notamment en cas de donnÃ©es incomplÃ¨tes, incorrectes ou incohÃ©rentes.
</p>

<p>
Il appartient Ã  lâ€™utilisateur de vÃ©rifier la cohÃ©rence des paramÃ¨tres saisis
(base hebdomadaire, absences, rÃ©cupÃ©rations, jours fÃ©riÃ©s, pÃ©riodes de clÃ´ture, etc.)
et de contrÃ´ler les rÃ©sultats obtenus.
</p>

<p>
Les rÃ©sultats affichÃ©s ne sauraient engager la responsabilitÃ© de lâ€™Ã©diteur.
Seuls les documents Ã©tablis par lâ€™employeur (bulletins de paie, dÃ©comptes officiels)
et lâ€™interprÃ©tation des textes lÃ©gaux et conventionnels font foi.
</p>

<hr>

<h4>ğŸ“š Sources officielles</h4>

<ul>
  <li>
    <a href="https://www.legifrance.gouv.fr/codes/id/LEGITEXT000006072050/"
       target="_blank" rel="noopener">
      Code du travail â€“ LÃ©gifrance
    </a>
  </li>
  <li>
    <a href="https://www.legifrance.gouv.fr/conv_coll/id/KALICONT000005635624"
       target="_blank" rel="noopener">
      Convention collective nationale du commerce de gros (IDCC 573)
    </a>
  </li>
</ul>

<p>
Cet outil ne constitue pas un conseil juridique et ne se substitue pas Ã  lâ€™analyse
dâ€™un professionnel compÃ©tent.
</p>

    <button onclick="closeLegalPopup()">Fermer</button>
  </div>
</div>
<!-- ğŸ”¼ FIN POPUP LÃ‰GAL -->

<div class="popup" id="popupYears">
  <div class="popup-content">
    <h3>ğŸ“ Exercices existants</h3>
    <div id="yearsList"></div>
    <hr>
    <label>CrÃ©er / ouvrir un nouvel exercice</label>
    <input type="number" id="newYearInput" placeholder="Ex : 2039">
    <button onclick="confirmSwitchYear()">Ouvrir</button>
    <button onclick="closeYearsPopup()">Fermer</button>
  </div>
</div>
<script>
  // ğŸ” Indique que l'application est active (anti-refresh / anti-retour menu)
  sessionStorage.setItem("appAlive", "true");
</script>
</body>
</html>
